<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 8 - MCP Integration Testing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .connection-panel {
            height: fit-content;
        }

        .connection-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status-connected {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .tools-section {
            margin-top: 30px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tool-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .tool-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tool-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .tool-description {
            color: #6b7280;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .tool-parameters {
            margin-bottom: 15px;
        }

        .parameter-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }

        .parameter-name {
            font-weight: 600;
            color: #374151;
        }

        .parameter-required {
            color: #dc2626;
            font-size: 0.8rem;
        }

        .parameter-description {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .execution-form {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
        }

        .execution-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .result-success {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0c4a6e;
        }

        .result-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #7f1d1d;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .server-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .info-item {
            margin-bottom: 8px;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
        }

        .info-value {
            color: #6b7280;
        }

        .hidden {
            display: none;
        }

        .text-center {
            text-align: center;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .tools-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîå MCP Integration Tester</h1>
            <p>Day 8 - Model Context Protocol Tool Discovery & Execution</p>
        </div>

        <div class="main-content">
            <!-- Connection Panel -->
            <div class="panel connection-panel">
                <h2>üîó MCP Connection</h2>
                
                <div id="connectionStatus" class="connection-status status-disconnected">
                    ‚ùå Disconnected from MCP Server
                </div>

                <button id="connectBtn" class="btn btn-primary">Connect to MCP Server</button>
                <button id="disconnectBtn" class="btn btn-danger hidden">Disconnect</button>
                <button id="discoverBtn" class="btn btn-success hidden">Discover Tools</button>

                <div id="serverInfo" class="server-info hidden">
                    <h3>üìã Server Information</h3>
                    <div class="info-item">
                        <span class="info-label">Name:</span>
                        <span id="serverName" class="info-value">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Version:</span>
                        <span id="serverVersion" class="info-value">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tools Available:</span>
                        <span id="toolCount" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Capabilities:</span>
                        <span id="capabilities" class="info-value">-</span>
                    </div>
                </div>
            </div>

            <!-- Status Panel -->
            <div class="panel">
                <h2>üìä Connection Status</h2>
                <div id="statusMessages" style="min-height: 100px; max-height: 300px; overflow-y: auto; padding: 10px; background: #f9fafb; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
                    Ready to connect to MCP server...
                </div>
            </div>
        </div>

        <!-- Tools Section -->
        <div class="tools-section">
            <div class="panel">
                <h2>üõ†Ô∏è Available Tools</h2>
                <div id="toolsContainer">
                    <div class="text-center" style="padding: 40px; color: #6b7280;">
                        Connect to MCP server and discover tools to see them here.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MCPTester {
            constructor() {
                this.isConnected = false;
                this.tools = [];
                this.initializeElements();
                this.setupEventListeners();
                this.checkStatus();
            }

            initializeElements() {
                this.elements = {
                    connectionStatus: document.getElementById('connectionStatus'),
                    connectBtn: document.getElementById('connectBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    discoverBtn: document.getElementById('discoverBtn'),
                    serverInfo: document.getElementById('serverInfo'),
                    serverName: document.getElementById('serverName'),
                    serverVersion: document.getElementById('serverVersion'),
                    toolCount: document.getElementById('toolCount'),
                    capabilities: document.getElementById('capabilities'),
                    statusMessages: document.getElementById('statusMessages'),
                    toolsContainer: document.getElementById('toolsContainer')
                };
            }

            setupEventListeners() {
                this.elements.connectBtn.addEventListener('click', () => this.connect());
                this.elements.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.elements.discoverBtn.addEventListener('click', () => this.discoverTools());
            }

            async checkStatus() {
                try {
                    const response = await fetch('/api/mcp/status');
                    const data = await response.json();
                    
                    if (data.connected) {
                        this.updateConnectionState(true, data.connectionInfo);
                        await this.loadTools();
                    } else {
                        this.updateConnectionState(false);
                    }
                } catch (error) {
                    this.addStatusMessage('‚ùå Failed to check connection status', 'error');
                }
            }

            async connect() {
                this.addStatusMessage('üîó Connecting to MCP server...', 'info');
                this.elements.connectBtn.disabled = true;
                this.elements.connectBtn.innerHTML = '<span class="loading"></span> Connecting...';

                try {
                    const response = await fetch('/api/mcp/connect', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        this.addStatusMessage('‚úÖ ' + data.message, 'success');
                        this.updateConnectionState(true, data);
                        await this.discoverTools();
                    } else {
                        this.addStatusMessage('‚ùå Connection failed: ' + data.error, 'error');
                        this.updateConnectionState(false);
                    }
                } catch (error) {
                    this.addStatusMessage('‚ùå Connection error: ' + error.message, 'error');
                    this.updateConnectionState(false);
                } finally {
                    this.elements.connectBtn.disabled = false;
                    this.elements.connectBtn.innerHTML = 'Connect to MCP Server';
                }
            }

            async disconnect() {
                this.addStatusMessage('üîå Disconnecting from MCP server...', 'info');
                
                try {
                    const response = await fetch('/api/mcp/disconnect', { method: 'POST' });
                    const data = await response.json();

                    this.addStatusMessage('‚úÖ ' + data.message, 'success');
                    this.updateConnectionState(false);
                    this.clearTools();
                } catch (error) {
                    this.addStatusMessage('‚ùå Disconnect error: ' + error.message, 'error');
                }
            }

            async discoverTools() {
                this.addStatusMessage('üîç Discovering available tools...', 'info');
                this.elements.discoverBtn.disabled = true;
                this.elements.discoverBtn.innerHTML = '<span class="loading"></span> Discovering...';

                try {
                    const response = await fetch('/api/mcp/tools/discover', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        this.addStatusMessage(`‚úÖ ${data.message}`, 'success');
                        this.tools = data.tools;
                        this.displayTools();
                        this.elements.toolCount.textContent = data.count;
                    } else {
                        this.addStatusMessage('‚ùå Tool discovery failed: ' + data.error, 'error');
                    }
                } catch (error) {
                    this.addStatusMessage('‚ùå Discovery error: ' + error.message, 'error');
                } finally {
                    this.elements.discoverBtn.disabled = false;
                    this.elements.discoverBtn.innerHTML = 'Discover Tools';
                }
            }

            async loadTools() {
                try {
                    const response = await fetch('/api/mcp/tools');
                    const data = await response.json();

                    if (data.success && data.connected) {
                        this.tools = data.tools;
                        this.displayTools();
                    }
                } catch (error) {
                    console.error('Failed to load tools:', error);
                }
            }

            updateConnectionState(connected, connectionInfo = null) {
                this.isConnected = connected;
                
                if (connected) {
                    this.elements.connectionStatus.className = 'connection-status status-connected';
                    this.elements.connectionStatus.textContent = '‚úÖ Connected to MCP Server';
                    this.elements.connectBtn.classList.add('hidden');
                    this.elements.disconnectBtn.classList.remove('hidden');
                    this.elements.discoverBtn.classList.remove('hidden');
                    
                    if (connectionInfo && connectionInfo.serverInfo) {
                        this.elements.serverInfo.classList.remove('hidden');
                        this.elements.serverName.textContent = connectionInfo.serverInfo.name || 'Unknown';
                        this.elements.serverVersion.textContent = connectionInfo.serverInfo.version || 'Unknown';
                        this.elements.capabilities.textContent = 
                            JSON.stringify(connectionInfo.serverInfo.capabilities || {});
                    }
                } else {
                    this.elements.connectionStatus.className = 'connection-status status-disconnected';
                    this.elements.connectionStatus.textContent = '‚ùå Disconnected from MCP Server';
                    this.elements.connectBtn.classList.remove('hidden');
                    this.elements.disconnectBtn.classList.add('hidden');
                    this.elements.discoverBtn.classList.add('hidden');
                    this.elements.serverInfo.classList.add('hidden');
                    this.elements.toolCount.textContent = '0';
                }
            }

            displayTools() {
                if (this.tools.length === 0) {
                    this.elements.toolsContainer.innerHTML = `
                        <div class="text-center" style="padding: 40px; color: #6b7280;">
                            No tools discovered. Click "Discover Tools" to find available tools.
                        </div>
                    `;
                    return;
                }

                const toolsHTML = this.tools.map(tool => this.createToolCard(tool)).join('');
                this.elements.toolsContainer.innerHTML = `<div class="tools-grid">${toolsHTML}</div>`;
            }

            createToolCard(tool) {
                const parameters = tool.inputSchema?.properties || {};
                const required = tool.inputSchema?.required || [];

                const parametersHTML = Object.entries(parameters).map(([key, param]) => {
                    const isRequired = required.includes(key);
                    return `
                        <div class="parameter-item">
                            <div class="parameter-name">
                                ${key} 
                                ${isRequired ? '<span class="parameter-required">(required)</span>' : ''}
                            </div>
                            <div class="parameter-description">
                                ${param.description || param.type || 'No description'}
                                ${param.default ? ` [default: ${param.default}]` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                const formHTML = this.createToolForm(tool);

                return `
                    <div class="tool-card">
                        <div class="tool-header">
                            <div>
                                <div class="tool-name">${tool.name}</div>
                                <div class="tool-description">${tool.description}</div>
                            </div>
                        </div>
                        
                        <div class="tool-parameters">
                            <strong>Parameters:</strong>
                            ${parametersHTML || '<div style="color: #6b7280; font-style: italic;">No parameters</div>'}
                        </div>

                        ${formHTML}
                    </div>
                `;
            }

            createToolForm(tool) {
                const parameters = tool.inputSchema?.properties || {};
                const required = tool.inputSchema?.required || [];

                const formFields = Object.entries(parameters).map(([key, param]) => {
                    const isRequired = required.includes(key);
                    const fieldId = `${tool.name}_${key}`;
                    
                    if (param.enum) {
                        const options = param.enum.map(option => 
                            `<option value="${option}">${option}</option>`
                        ).join('');
                        
                        return `
                            <div class="form-group">
                                <label class="form-label" for="${fieldId}">
                                    ${key} ${isRequired ? '*' : ''}
                                </label>
                                <select class="form-select" id="${fieldId}" ${isRequired ? 'required' : ''}>
                                    <option value="">Select ${key}</option>
                                    ${options}
                                </select>
                            </div>
                        `;
                    }
                    
                    const inputType = param.type === 'number' ? 'number' : 'text';
                    
                    return `
                        <div class="form-group">
                            <label class="form-label" for="${fieldId}">
                                ${key} ${isRequired ? '*' : ''}
                            </label>
                            <input 
                                type="${inputType}" 
                                class="form-input" 
                                id="${fieldId}" 
                                placeholder="${param.description || key}"
                                ${param.default ? `value="${param.default}"` : ''}
                                ${isRequired ? 'required' : ''}
                            />
                        </div>
                    `;
                }).join('');

                return `
                    <div class="execution-form">
                        <strong>üß™ Test Tool</strong>
                        ${formFields}
                        <button class="btn btn-primary" onclick="mcpTester.executeTool('${tool.name}')">
                            Execute Tool
                        </button>
                        <div id="${tool.name}_result" class="execution-result hidden"></div>
                    </div>
                `;
            }

            async executeTool(toolName) {
                const tool = this.tools.find(t => t.name === toolName);
                if (!tool) return;

                // Collect form parameters
                const parameters = {};
                const paramSchema = tool.inputSchema?.properties || {};

                Object.keys(paramSchema).forEach(key => {
                    const fieldId = `${toolName}_${key}`;
                    const element = document.getElementById(fieldId);
                    if (element && element.value.trim()) {
                        const param = paramSchema[key];
                        let value = element.value.trim();
                        
                        // Convert to appropriate type
                        if (param.type === 'number') {
                            value = parseFloat(value);
                        }
                        
                        parameters[key] = value;
                    }
                });

                const resultElement = document.getElementById(`${toolName}_result`);
                resultElement.classList.remove('hidden', 'result-success', 'result-error');
                resultElement.innerHTML = '<span class="loading"></span> Executing tool...';

                this.addStatusMessage(`üß™ Executing tool: ${toolName}`, 'info');

                try {
                    const response = await fetch('/api/mcp/tools/execute', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            toolName,
                            parameters
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        resultElement.className = 'execution-result result-success';
                        resultElement.textContent = JSON.stringify(data.result, null, 2);
                        this.addStatusMessage(`‚úÖ Tool ${toolName} executed successfully (${data.executionTime}ms)`, 'success');
                    } else {
                        resultElement.className = 'execution-result result-error';
                        resultElement.textContent = `Error: ${data.error}`;
                        this.addStatusMessage(`‚ùå Tool execution failed: ${data.error}`, 'error');
                    }
                } catch (error) {
                    resultElement.className = 'execution-result result-error';
                    resultElement.textContent = `Network error: ${error.message}`;
                    this.addStatusMessage(`‚ùå Network error: ${error.message}`, 'error');
                }
            }

            clearTools() {
                this.tools = [];
                this.elements.toolsContainer.innerHTML = `
                    <div class="text-center" style="padding: 40px; color: #6b7280;">
                        Connect to MCP server and discover tools to see them here.
                    </div>
                `;
            }

            addStatusMessage(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
                
                this.elements.statusMessages.innerHTML += 
                    `[${timestamp}] ${emoji} ${message}\n`;
                this.elements.statusMessages.scrollTop = this.elements.statusMessages.scrollHeight;
            }
        }

        // Initialize the MCP Tester
        const mcpTester = new MCPTester();
    </script>
</body>
</html>